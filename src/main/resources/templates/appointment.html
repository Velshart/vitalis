<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Nowa Wizyta</title>
    <link rel="stylesheet" href="/css/wizyta.css">
    <link rel="icon" type="image/x-icon" href="/css/favicon.ico">
    <script>
        async function checkAppointmentExists() {
            const doctorId = document.getElementById('doctorId').value;
            const date = document.getElementById('date').value;
            const time = document.getElementById('time').value;

            if (!doctorId || !date || !time) {
                return true;
            }

            const response = await fetch(`/appointment/exists?doctorId=${doctorId}&date=${date}&time=${time}`);
            const exists = await response.json();

            if (exists) {
                document.getElementById('error').innerText = 'Wizyta na tę datę i godzinę do tego lekarza już istnieje.';
                return false;
            }

            document.getElementById('error').innerText = '';
            return true;
        }

        async function validateForm(event) {
            const isValid = await checkAppointmentExists();
            if (!isValid) {
                event.preventDefault();
            }
        }
    </script>
</head>
<body>
<header>
    <div class="logo">
        <img src="/img/logo.png" alt="Logo">
    </div>
    <nav>
        <nav>
            <ul>
                <li><a th:href="@{/patient/home}">Panel główny</a></li>
                <li><a th:href="@{/logout}">Wyloguj się</a></li>
            </ul>
        </nav>
    </nav>
</header>
<div class="main-content">
    <div class="container">
        <h1>Dodaj Wizytę</h1>
        <div class="form-container">
            <form method="post" th:action="@{/appointment/add}" th:object="${appointment}" onsubmit="validateForm(event)">
                <input type="hidden" th:name="patientId" th:value="${patient.id}"/>
                <input type="hidden" th:name="clinicId" th:value="${clinic.id}"/>

                <label for="doctorId">Lekarz:</label>
                <select id="doctorId" name="doctorId" required onchange="checkAppointmentExists()">
                    <option value="" disabled selected>Wybierz Lekarza</option>
                    <option th:each="doctor : ${doctors}"
                            th:value="${doctor.id}"
                            th:text="${doctor.username + ' - ' + doctorSpecializations.get(doctor.username)}">
                    </option>
                </select>

                <label for="date">Data:</label>
                <input type="date" id="date" th:field="*{date}" required th:min="${currentDate}" onchange="checkAppointmentExists()">

                <label for="time">Godzina:</label>
                <input type="time" id="time" th:field="*{time}" required onchange="checkAppointmentExists()">

                <label for="comment">Komentarz:</label>
                <input type="text" id="comment" placeholder="Komentarz" th:field="*{comment}">

                <input type="submit" value="Zatwierdź">
            </form>
            <br>
            <form th:action="@{/patient/home}" method="get">
                <button type="submit">Anuluj</button>
            </form>
            <br>
            <div id="error" class="error-message"></div>
        </div>
    </div>
</div>
</body>
</html>